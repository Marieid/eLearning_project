{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
  <h3 class="mb-4">Chat Room: {{ room_name }}</h3>

  <!-- Chat Log Section -->
  <div id="chat-log" class="border rounded p-3 mb-4" style="height: 300px; overflow-y: scroll;">
    <!-- Chat messages will be dynamically added here -->
    {% for message in messages %}
    <p><strong>{{ message.user.username }}:</strong> {{ message.content }}</p>
    {% endfor %}
  </div>

  <!-- Chat Message Form -->
  <form id="chat-message-form" class="d-flex">
    <input
      type="text"
      id="chat-message-input"
      class="form-control me-2"
      autocomplete="off"
      placeholder="Type your message..."
      required
    />
    <button type="submit" class="btn btn-primary">Send</button>
  </form>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var roomName = "{{ room_name }}";
    var chatLog = document.querySelector("#chat-log");
    var chatSocket = new WebSocket("ws://" + window.location.host + "/ws/chat/" + roomName + "/");

    // Handle connection events
    chatSocket.onopen = function() {
      console.log("WebSocket connection opened");
    };

    chatSocket.onmessage = function(e) {
      var data = JSON.parse(e.data);
      var message = data.message;
      var username = data.username;

      // Append the new message to the chat log
      var newMessage = document.createElement('p');
      newMessage.innerHTML = "<strong>" + username + ":</strong> " + message;
      chatLog.appendChild(newMessage);

      // Auto-scroll to the latest message
      chatLog.scrollTop = chatLog.scrollHeight;
    };

    chatSocket.onerror = function(e) {
      console.error('WebSocket error: ', e);
    };

    chatSocket.onclose = function(e) {
      console.log('WebSocket connection closed: ', e);
    };
    // Handle sending a new message
    document.querySelector("#chat-message-form").onsubmit = function(e) {
      e.preventDefault();
      var messageInputDom = document.querySelector("#chat-message-input");
      var message = messageInputDom.value.trim();

      if (message.length > 0) {
        chatSocket.send(JSON.stringify({
          'message': message
        }));
        messageInputDom.value = ""; // Clear the input field
      }
    };
  });
</script>

{% endblock %}
