{% extends 'base.html' %}
{% block content %}
<h2>User Profile</h2>

<h3>{{ user.first_name }} {{ user.last_name }}</h3>

{% if user.profile_picture %}
<img src="{{ user.profile_picture.url }}" alt="Profile Picture" width="200" />
{% else %}
<p>No profile picture yet.</p>
{% endif %}

<p>Username: {{ user.username }}</p>
<p>Email: {{ user.email }}</p>
<a href="{% url 'edit_profile' %}">Edit Profile</a>

{% if user.elearnuser.user_type == 'student' %}
<h3>Enrolled Courses</h3>
<ul>
  {% for course in user.elearnuser.enrolled_courses.all %}
  <li>
    <a href="{% url 'course_detail' course.id %}">{{ course.name }}</a>
  </li>
  {% endfor %}
</ul>

<h3>Feedback</h3>
<ul>
  {% for feedback in user.elearnuser.feedback_set.all %}
  <li>
    Course: {{ feedback.course.name }}<br />
    Rating: {{ feedback.rating }}<br />
    Comment: {{ feedback.comment }}
  </li>
  {% endfor %}
</ul>

{% elif user.elearnuser.user_type == 'teacher' %}
<h3>Courses Taught</h3>
<ul>
  {% for course in courses_taught %}
  <li>
    <a href="{% url 'course_detail' course.id %}">{{ course.name }}</a>
    <a href="{% url 'edit_course' course.id %}"> Edit </a> |
    <a href="{% url 'delete_course' course.id %}" onclick="return confirm('Are you sure you want to delete this course?')">Delete</a>
    {% if course.enrollment_status == 'open' %} |
    <a href="{% url 'close_enrollment' course.id %}" onclick="return confirm('Are you sure you want to close enrollment for this course?')">Close Enrollment</a>
    {% else %} |
    <a href="{% url 'open_enrollment' course.id %}" onclick="return confirm('Are you sure you want to reopen enrollment for this course?')">Reopen Enrollment</a>
    {% endif %} | <a href="{% url 'add_material' course.id %}">Add Material</a>

    <h4>Materials</h4>
    <ul>
      {% for material in course.material_set.all %}
      <li>
        <a href="{{ material.file.url }}">{{ material.file.name }}</a>
        <a href="{% url 'edit_material' course.id material.id %}">Edit</a> |
        <a href="{% url 'delete_material' course.id material.id %}" onclick="return confirm('Are you sure you want to delete this material?')">Delete</a>
      </li>
      {% endfor %}
    </ul>
  </li>
  {% endfor %}
</ul>
{% endif %}

<h3>Status Updates</h3>
<ul id="status-updates-list">
  {% for status_update in user.statusupdate_set.all %}
  {% include 'eLearning_app/status_update.html' %}
  {% if user == status_update.user %}
  <a href="{% url 'edit_status_update' status_update.id %}">Edit</a> |
  <a href="{% url 'delete_status_update' status_update.id %}" onclick="return confirm('Are you sure you want to delete this status update?')">Delete</a>
  {% endif %}
  {% endfor %}
</ul>

{% if user.is_authenticated %}
<h3>Post a New Status Update</h3>
<form id="status-update-form" method="post">
  {% csrf_token %}
  {{ status_update_form.as_p }}
  <button type="submit">Post</button>
</form>
{% endif %}

<h3>Chat Rooms</h3>
<ul>
  {% for chat_room in user.chat_rooms.all %}
  <li>
    <a href="{% url 'chat_room_detail' chat_room.chat_name %}">{{ chat_room.chat_name }}</a>
  </li>
  {% endfor %}
</ul>

<!-- Link to the chat rooms page -->
<h3>Manage Chat Rooms</h3>
<a href="{% url 'chat_rooms' %}">Go to Chat Rooms</a>

{% block scripts %}
<script>
  console.log("Script Loaded");
  $(document).ready(function () {
    $("#status-update-form").on("submit", function (event) {
      event.preventDefault();
      $.ajax({
        type: "POST",
        url: "{% url 'post_status_update' %}",
        data: $(this).serialize(),
        beforeSend: function (xhr, settings) {
          xhr.setRequestHeader("X-CSRFToken", $("input[name=csrfmiddlewaretoken]").val());
        },
        success: function (response) {
          console.log("Success", response);
          $("#status-updates-list").prepend(response.html);
          $("#status-update-form")[0].reset();
        },
        error: function (xhr, errmsg, err) {
          console.log("Error", xhr.status + ": " + xhr.responseText);
        },
      });
    });
  });
</script>
{% endblock %}
{% endblock %}
