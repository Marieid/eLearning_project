{% extends 'base.html' %} {% block content %}
<h2>User Profile</h2>

<h3>{{ user.first_name }} {{ user.last_name }}</h3>

{% if user.profile_picture %}
<img src="{{ user.profile_picture.url }}" alt="Profile Picture" width="200" />
{% else %}
<p>No profile picture yet.</p>
{% endif %}

<p>Username: {{ user.username }}</p>
<p>Email: {{ user.email }}</p>
<a href="{% url 'edit_profile' %}">Edit Profile</a>

{% if user.elearnuser.user_type == 'student' %}
<h3>Enrolled Courses</h3>
<ul>
  {% for course in user.elearnuser.enrolled_courses.all %}
  <li>
    <a href="{% url 'course_detail' course.id %}">{{ course.name }}</a>
  </li>
  {% endfor %}
</ul>

<h3>Feedback</h3>
<ul>
  {% for feedback in user.elearnuser.feedback_set.all %}
  <li>
    Course: {{ feedback.course.name }}<br />
    Rating: {{ feedback.rating }}<br />
    Comment: {{ feedback.comment }}
  </li>
  {% endfor %}
</ul>

{% elif user.elearnuser.user_type == 'teacher' %}
<h3>Courses Taught</h3>
<ul>
  {% for course in courses_taught %}
  <li>
    <a href="{% url 'course_detail' course.id %}">{{ course.name }}</a>
    <a href="{% url 'edit_course' course.id %}"> Edit </a> |
    <a
      href="{% url 'delete_course' course.id %}"
      onclick="return confirm('Are you sure you want to delete this course?')"
      >Delete</a
    >
    {% if course.enrollment_status == 'open' %} |
    <a
      href="{% url 'close_enrollment' course.id %}"
      onclick="return confirm('Are you sure you want to close enrollment for this course?')"
      >Close Enrollment</a
    >
    {% else %} |
    <a
      href="{% url 'open_enrollment' course.id %}"
      onclick="return confirm('Are you sure you want to reopen enrollment for this course?')"
      >Reopen Enrollment</a
    >
    {% endif %} | <a href="{% url 'add_material' course.id %}">Add Material</a>

    <h4>Materials</h4>
    <ul>
      {% for material in course.material_set.all %}
      <li>
        <a href="{{ material.file.url }}">{{ material.file.name }}</a>
        <a href="{% url 'edit_material' course.id material.id %}">Edit</a> |
        <a
          href="{% url 'delete_material' course.id material.id %}"
          onclick="return confirm('Are you sure you want to delete this material?')"
          >Delete</a
        >
      </li>
      {% endfor %}
    </ul>
  </li>
  {% endfor %}
</ul>
{% endif %}

<h3>Status Updates</h3>
<ul id="status-updates-list">
  {% for status_update in user.statusupdate_set.all %} {% include
  'eLearning_app/status_update.html' %} {% endfor %}
</ul>

{% if user.is_authenticated %}
<h3>Post a New Status Update</h3>
<form id="status-update-form" method="post">
  {% csrf_token %} {{ status_update_form.as_p }}
  <button type="submit">Post</button>
</form>
{% endif %}

<h3>Chat Rooms</h3>
<ul>
  {% for chat_room in user.chat_rooms.all %}
  <li>{{ chat_room.name }}</li>
  {% endfor %}
</ul>

{% endblock %} 

{% block scripts %}
<script>
  var jQuery = $.noConflict();
  jQuery(document).ready(function() {
    $("#status-update-form").submit(function (event) {
      // Prevent default form submission
      event.preventDefault();

      // Log the serialized form data before sending the request
      console.log("Form data:", $(this).serialize());

      $.ajax({
        type: "POST",
        url: '{% url "post_status_update" %}',
        data: $(this).serialize(),
        contentType: false,  
        processData: false,   
        success: function (response) {
          if (response.success) {
            console.log("AJAX Success: Status update posted successfully!");
            console.log("Response data:", response); 
            $("#status-updates-list").prepend(response.new_status_update_html);
            $("#status-update-form")[0].reset();
          } else {
            console.error("AJAX Error: Failed to post status update.");
            console.error("Error details:", response.errors || response.message);
          }
        },
        error: function (error) {
          console.error("AJAX Error: An error occurred during the request.");
          console.error("Error details:", error);
        },
      });
    });
  });
</script>
{% endblock %}